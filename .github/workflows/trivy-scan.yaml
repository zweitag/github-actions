# .github/workflows/security-scan.yaml
name: Security Scan

on:
  workflow_call:
    inputs:
      scan-type:
        description: 'Type of scan to perform: "image", "filesystem" (default), or "config"'
        required: false
        default: 'filesystem'
        type: string
      trivyignorefile:
        description: 'Path to the Trivy ignore file (default: none)'
        default: ''
        required: false
        type: string
      path:
        description: 'Directory path where the scan should be performed (default: .) (for image scans, the directory must contain the Dockerfile)'
        required: false
        default: '.'
        type: string
      use-test-reporter:
        description: 'Whether to attach the test results as a report (default: true)'
        required: false
        default: 'true'
        type: boolean
      issue-on-findings:
        description: 'GitHub users to assign when creating an issue for failed scans (comma-separated list: ''@user1'', ''@user2''). If left empty, no issue will be created.'
        required: false
        default: 'false'
        type: string
    secrets:
      GH_TOKEN:
        description: 'GitHub Token for downloading the Trivy DB'
        required: false
      DOCKER_IMAGE_SECRETS:
        description: 'Docker Image Build Secrets'
        required: false

env:
  TRIVY_DB_REPOSITORY: public.ecr.aws/aquasecurity/trivy-db,aquasec/trivy-db,ghcr.io/aquasecurity/trivy-db

jobs:

  configuration_scan:
    if: ${{ inputs.scan-type == 'config' }}
    outputs:
      NOTIFICATION: ${{ steps.scan.outcome == 'failure' && 'true' || 'false' }}
    runs-on: ubuntu-latest

    steps:
    - name: checkout repository
      uses: actions/checkout@v4

    - name: setup trivy
      uses: aquasecurity/setup-trivy@e07451d2e059ed86c2870430ea286b3a9e0bf241
    
    - name: scan configuration for full report
      if: always()
      run: |
        trivy config ${{ inputs.path }} --exit-code 0

    - name: scan configuration for new medium, high, critical and unknown severities
      if: always()
      env:
        REPORT: ${{ inputs.use-test-reporter == true && '-f json >> security-scanning/trivy.json' || '' }}
        IGNOREFILE: ${{ inputs.trivyignorefile != '' && format('--ignorefile {0}', inputs.trivyignorefile) || '' }}
      id: scan
      run: |
        trivy config ${{ inputs.path }} \
          --exit-code 1 \
          --skip-db-update \
          --severity HIGH,CRITICAL,UNKNOWN \
          --scanners vuln \
          --timeout 10m \
          $IGNOREFILE \
          $REPORT

    - name: convert Trivy report to CTRF format
      if: always() && ${{ inputs.use-test-reporter }}
      run: |
        python3 security-scanning/trivyconfig2ctrf.py ./security-scanning/trivy.json ./security-scanning/trivy.ctrf.json
    
    - name: Publish Test Report
      if: always() && ${{ inputs.use-test-reporter }}
      uses: ctrf-io/github-test-reporter@v1
      with:
        report-path: './security-scanning/trivy.ctrf.json'
        template-path: './security-scanning/config_scan_template.hbs'
        custom-report: true

  filesystem_scan:
    if: ${{ inputs.scan-type == 'filesystem' || inputs.scan-type == '' }}
    outputs:
      NOTIFICATION: ${{ steps.scan.outcome == 'failure' && 'true' || 'false' }}
    runs-on: ubuntu-latest

    steps:
    - name: checkout repository
      uses: actions/checkout@v4
    
    - name: setup trivy
      uses: aquasecurity/setup-trivy@e07451d2e059ed86c2870430ea286b3a9e0bf241

    - name: download vulnerabilities database from aws
      run: |
        MAX_RETRIES=3
        RETRY_DELAY=60
        ATTEMPT=1
        
        until [ $ATTEMPT -gt $MAX_RETRIES ]
        do
          echo "Attempt $ATTEMPT of $MAX_RETRIES..."
          GITHUB_TOKEN=${{ secrets.GH_TOKEN }} trivy fs --download-db-only --db-repository "${{ env.TRIVY_DB_REPOSITORY }}"

          if [ $? -eq 0 ]; then
            echo "Trivy DB download succeeded."
            exit 0
          else
            echo "Trivy DB download failed. Retrying in $RETRY_DELAY seconds..."
            ATTEMPT=$((ATTEMPT + 1))
            sleep $RETRY_DELAY
          fi
        done
        exit 1

    - name: download vulnerabilities database if aws failed
      if: failure()
      run: |
        MAX_RETRIES=3
        RETRY_DELAY=60
        ATTEMPT=1
        
        until [ $ATTEMPT -gt $MAX_RETRIES ]
        do
          echo "Attempt $ATTEMPT of $MAX_RETRIES..."
          GITHUB_TOKEN=${{ secrets.GH_TOKEN }} trivy fs --download-db-only

          if [ $? -eq 0 ]; then
            echo "Trivy DB download succeeded."
            exit 0
          else
            echo "Trivy DB download failed. Retrying in $RETRY_DELAY seconds..."
            ATTEMPT=$((ATTEMPT + 1))
            sleep $RETRY_DELAY
          fi
        done
        exit 1

    - name: scan filesystem for full report
      if: always()
      run: |
        trivy fs ${{ inputs.path }} --exit-code 0 --skip-db-update

    # ob mit report geht weiÃŸ ich noch nicht
    - name: scan filesystem for new medium, high, critical and unknown severities with report and ignorefile
      if: always()
      id: scan
      env:
        REPORT: ${{ inputs.use-test-reporter == true && '-f json > ./security-scanning/trivy.json' || '' }}
        IGNOREFILE: ${{ inputs.trivyignorefile != '' && format('--ignorefile {0}', inputs.trivyignorefile) || '' }}
      run: |
        trivy fs ${{ inputs.path }} \
          --exit-code 1 \
          --skip-db-update \
          --severity MEDIUM,HIGH,CRITICAL,UNKNOWN \
          $IGNOREFILE \
          $REPORT

    - name: Publish Test Report
      if: always() && ${{ inputs.use-test-reporter }} 
      uses: ctrf-io/github-test-reporter@v1
      with:
        report-path: './security-scanning/trivy.ctrf.json'
        template-path: './security-scanning/config_scan_template.hbs'
        custom-report: true

  image_scan:
    if: ${{ inputs.scan-type == 'image' }}
    outputs:
      NOTIFICATION: ${{ steps.scan.outcome == 'failure' && 'true' || 'false' }}
    runs-on: ubuntu-latest

    steps:
    - name: checkout repository
      uses: actions/checkout@v4 

    - name: setup trivy
      uses: aquasecurity/setup-trivy@e07451d2e059ed86c2870430ea286b3a9e0bf241

    - name: download vulnerabilities database from aws
      run: |
        MAX_RETRIES=3
        RETRY_DELAY=60
        ATTEMPT=1
        
        until [ $ATTEMPT -gt $MAX_RETRIES ]
        do
          echo "Attempt $ATTEMPT of $MAX_RETRIES..."
          GITHUB_TOKEN=${{ secrets.GH_TOKEN }} trivy fs --download-db-only --db-repository "${{ env.TRIVY_DB_REPOSITORY }}"

          if [ $? -eq 0 ]; then
            echo "Trivy DB download succeeded."
            exit 0
          else
            echo "Trivy DB download failed. Retrying in $RETRY_DELAY seconds..."
            ATTEMPT=$((ATTEMPT + 1))
            sleep $RETRY_DELAY
          fi
        done
        exit 1

    - name: download vulnerabilities database if aws failed
      if: failure()
      run: |
        MAX_RETRIES=3
        RETRY_DELAY=60
        ATTEMPT=1
        
        until [ $ATTEMPT -gt $MAX_RETRIES ]
        do
          echo "Attempt $ATTEMPT of $MAX_RETRIES..."
          GITHUB_TOKEN=${{ secrets.GH_TOKEN }} trivy fs --download-db-only

          if [ $? -eq 0 ]; then
            echo "Trivy DB download succeeded."
            exit 0
          else
            echo "Trivy DB download failed. Retrying in $RETRY_DELAY seconds..."
            ATTEMPT=$((ATTEMPT + 1))
            sleep $RETRY_DELAY
          fi
        done
        exit 1

    - name: scan filesystem for full report
      if: always()
      run: |
        trivy fs ${{ inputs.path }} --exit-code 0 --skip-db-update

    - name: build docker image
      uses: docker/build-push-action@v4
      with:
        context: ${{ inputs.path }}
        push: false
        tags: security-scan-image
        secrets: ${{ secrets.DOCKER_IMAGE_SECRETS }}

    - name: scan image for full report
      run: |
        trivy image security-scan-image --exit-code 0 --skip-db-update --scanners vuln --timeout 10m --list-all-pkgs
      
    - name: scan docker image for high, critical and unknown severities
      if: always()
      env:
        REPORT: ${{ inputs.use-test-reporter == true && '-f json >> security-scanning/trivy.json' || '' }}
        IGNOREFILE: ${{ inputs.trivyignorefile != '' && format('--ignorefile {0}', inputs.trivyignorefile) || '' }}
      id: scan
      run: |
        trivy image security-scan-image \
          --exit-code 1 \
          --skip-db-update \
          --severity HIGH,CRITICAL,UNKNOWN \
          --scanners vuln \
          --timeout 10m \
          $IGNOREFILE \
          $REPORT

    - name: convert Trivy report to CTRF format
      if: always() && ${{ inputs.use-test-reporter }}
      run: |
        python3 security-scanning/trivyimage2ctrf.py ./security-scanning/trivy.json ./security-scanning/trivy.ctrf.json

    - name: Publish Test Report
      uses: ctrf-io/github-test-reporter@v1
      if: always() && ${{ inputs.use-test-reporter }}
      with:
        report-path: './security-scanning/trivy.ctrf.json'
        template-path: './security-scanning/image_scan_template.hbs'
        custom-report: true

  create_issues:
    needs: [configuration_scan, filesystem_scan, image_scan]
    runs-on: ubuntu-latest
    if: ${{ inputs.issue-on-findings != 'false' }}

    steps:
      - name: Create issue/Comment on issue
        if: ${{ always() && (needs.image_scan.outputs.NOTIFICATION == 'true' || needs.configuration_scan.outputs.NOTIFICATION == 'true' || needs.filesystem_scan.outputs.NOTIFICATION == 'true') }}
        uses: actions/github-script@v7
        with:
          script: |
            const repo = context.repo.repo;
            const owner = context.repo.owner;
            const issue_title = 'Security scan failed';
            const issue_body = 'One or more security scans failed. Please check the workflow run for more information: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\nPlease check if the vulnerabilities are fixable. If there is a fix: Create a ticket for the fix or resolve it.\n'
            const assignees = [${{ inputs.issue-on-findings }}];
            const existing_issue = await github.rest.issues.listForRepo({
              owner,
              repo,
              state: 'open',
              labels: 'security-scan-failure'
            });
            if (existing_issue.data.length === 0) {
            await github.rest.issues.create({
              owner,
              repo,
              title: issue_title,
              body: issue_body,
              labels: ['security-scan-failure']
              });
            } else {
              const issue_number = existing_issue.data[0].number;
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body: issue_body
              });
            }
